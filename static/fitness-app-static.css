let currentUserId = localStorage.getItem('user_id');
let currentUsername = localStorage.getItem('username');

// Document ready handler
document.addEventListener('DOMContentLoaded', function() {
    if (currentUserId) {
        fetchGoals();
        displayUsername();
    }
});

// Authentication Functions
function register() {
    const username = document.getElementById('register-username').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;

    fetch('/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            username: username,
            email: email,
            password: password
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Registration successful! Please log in.');
            window.location.href = '/';
        } else {
            alert(data.message || 'Registration failed. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Registration failed. Please try again.');
    });
}

function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    fetch('/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            username: username,
            password: password
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            localStorage.setItem('user_id', data.user_id);
            localStorage.setItem('username', username);
            window.location.href = '/dashboard';
        } else {
            alert('Login failed. Please check your credentials.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Login failed. Please try again.');
    });
}

function logout() {
    localStorage.removeItem('user_id');
    localStorage.removeItem('username');
    window.location.href = '/';
}

// Goal Management Functions
// Goal Management Functions
function openAddGoalModal() {
    document.getElementById('add-goal-modal').style.display = 'block';
}

function closeAddGoalModal() {
    document.getElementById('add-goal-modal').style.display = 'none';
    // Clear form fields
    document.getElementById('goal-category').value = '';
    document.getElementById('goal-description').value = '';
    document.getElementById('goal-target-date').value = '';
}

function createGoal() {
    const category = document.getElementById('goal-category').value;
    const description = document.getElementById('goal-description').value;
    const targetDate = document.getElementById('goal-target-date').value;

    if (!category || !description || !targetDate) {
        showErrorMessage('Please fill in all fields');
        return;
    }

    // Show loading state
    const createButton = document.querySelector('#create-goal-btn');
    if (createButton) {
        createButton.disabled = true;
        createButton.textContent = 'Creating...';
    }

    fetch('/goals', {  // Changed from '/set_goal' to '/goals'
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: currentUserId,
            category: category,
            description: description,
            target_date: targetDate
        }),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.id) {
            closeAddGoalModal();
            fetchGoals();
            showSuccessMessage('Goal created successfully!');
        } else {
            throw new Error(data.message || 'Failed to create goal');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorMessage('Failed to create goal: ' + error.message);
    })
    .finally(() => {
        // Reset button state
        if (createButton) {
            createButton.disabled = false;
            createButton.textContent = 'Create Goal';
        }
    });
}

// Add these new utility functions at the bottom of your file
function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success';
    alertDiv.textContent = message;
    
    // Create alert container if it doesn't exist
    let alertContainer = document.querySelector('.alert-container');
    if (!alertContainer) {
        alertContainer = document.createElement('div');
        alertContainer.className = 'alert-container';
        document.body.appendChild(alertContainer);
    }
    
    alertContainer.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
}

function showErrorMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger';
    alertDiv.textContent = message;
    
    // Create alert container if it doesn't exist
    let alertContainer = document.querySelector('.alert-container');
    if (!alertContainer) {
        alertContainer = document.createElement('div');
        alertContainer.className = 'alert-container';
        document.body.appendChild(alertContainer);
    }
    
    alertContainer.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
}

function fetchGoals() {
    fetch(`/get_goals/${currentUserId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(goals => {
            const goalsContainer = document.getElementById('goals-container');
            if (!goalsContainer) {
                console.error('Goals container not found');
                return;
            }
            goalsContainer.innerHTML = '';
            goals.forEach(goal => {
                const goalElement = createGoalCard(goal);
                goalsContainer.appendChild(goalElement);
            });
        })
        .catch(error => {
            console.error('Error fetching goals:', error);
            showErrorMessage('Failed to fetch goals');
        });
}

function createGoalCard(goal) {
    const card = document.createElement('div');
    card.className = 'goal-card';
    
    // Calculate progress color based on goal progress
    const progressColor = getProgressColor(goal.progress || 0);
    
    card.innerHTML = `
        <div class="goal-card-header" style="border-left: 4px solid ${progressColor}">
            <div class="goal-category">${goal.category}</div>
            <div class="goal-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${goal.progress || 0}%; background-color: ${progressColor}"></div>
                </div>
                <span>${goal.progress || 0}%</span>
            </div>
        </div>
        <div class="goal-description">${goal.description}</div>
        <div class="goal-meta">
            <span><i class="fas fa-calendar"></i> ${new Date(goal.target_date).toLocaleDateString()}</span>
        </div>
        <div class="goal-actions">
            <button onclick="viewGoalDetails(${goal.id})" class="action-button">
                <i class="fas fa-chart-line"></i> Track Progress
            </button>
            <button onclick="updateGoal(${goal.id})" class="action-button">
                <i class="fas fa-edit"></i> Edit
            </button>
            <button onclick="deleteGoal(${goal.id})" class="action-button delete">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    `;
    return card;
}

function getProgressColor(progress) {
    if (progress < 30) return '#ff4444';  // Red for low progress
    if (progress < 70) return '#ffbb33';  // Orange for medium progress
    return '#00C851';  // Green for good progress
}

function viewGoalDetails(goalId) {
    window.location.href = `/goal/${goalId}`;
}

function updateGoal(goalId) {
    fetch(`/get_goal/${goalId}`)
        .then(response => response.json())
        .then(goal => {
            const newCategory = prompt("New category:", goal.category);
            const newDescription = prompt("New description:", goal.description);
            const newTargetDate = prompt("New target date (YYYY-MM-DD):", goal.target_date);

            if (!newCategory && !newDescription && !newTargetDate) return;

            fetch('/update_goal', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: goalId,
                    category: newCategory || goal.category,
                    description: newDescription || goal.description,
                    target_date: newTargetDate || goal.target_date
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fetchGoals();
                } else {
                    alert('Failed to update goal');
                }
            });
        })
        .catch(error => console.error('Error:', error));
}

function deleteGoal(goalId) {
    if (confirm('Are you sure you want to delete this goal?')) {
        fetch(`/delete_goal/${goalId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                fetchGoals();
            } else {
                alert('Failed to delete goal');
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

// Progress Update Functions
function addProgressUpdate(goalId) {
    const updateText = document.getElementById('progress-update').value;
    if (!updateText.trim()) {
        alert('Please enter your progress update');
        return;
    }

    fetch(`/update_progress/${goalId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            update_text: updateText
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('progress-update').value = '';
            fetchProgressUpdates(goalId);
            if (data.analysis) {
                document.getElementById('ai-analysis').innerHTML = data.analysis;
            }
        } else {
            alert('Failed to add progress update');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add progress update');
    });
}

function fetchProgressUpdates(goalId) {
    fetch(`/get_progress/${goalId}`)
        .then(response => response.json())
        .then(data => {
            const updatesContainer = document.getElementById('progress-updates');
            updatesContainer.innerHTML = '';
            data.progress_updates.forEach(update => {
                const updateElement = createProgressUpdateElement(update);
                updatesContainer.appendChild(updateElement);
            });
        })
        .catch(error => console.error('Error:', error));
}

function createProgressUpdateElement(update) {
    const div = document.createElement('div');
    div.className = 'progress-update';
    div.innerHTML = `
        <div class="update-text">${update.update_text}</div>
        <div class="update-meta">
            <span class="update-date">${new Date(update.created_at).toLocaleString()}</span>
        </div>
        <div class="ai-feedback">${update.analysis || ''}</div>
    `;
    return div;
}

// Utility Functions
function displayUsername() {
    const usernameElement = document.getElementById('username-display');
    if (usernameElement && currentUsername) {
        usernameElement.textContent = `Welcome, ${currentUsername}!`;
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('add-goal-modal');
    if (event.target == modal) {
        closeAddGoalModal();
    }
}

// Error handling
function handleError(error) {
    console.error('Error:', error);
    alert('An error occurred. Please try again.');
}
